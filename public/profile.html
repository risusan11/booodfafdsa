<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</title>

<link id="theme" rel="stylesheet" href="/css/light.css">
<script src="/script/theme.js" defer></script>

<style>
body{
  font-family:"Meiryo",sans-serif;
  background:var(--bg);
  color:var(--text);
  margin:0;
}

nav{
  background:var(--card);
  padding:12px 24px;
  display:flex;
  align-items:center;
  border-bottom:1px solid var(--border);
}

nav a{
  color:var(--text);
  text-decoration:none;
  font-weight:600;
  margin-right:20px;
}
nav a:hover{ color:var(--accent); }

.container{
  width:90%;
  max-width:700px;
  margin:32px auto;
}

.card{
  background:var(--card);
  padding:24px;
  border-radius:14px;
  border:1px solid var(--border);
}

#icon{
  width:128px;
  height:128px;
  border-radius:50%;
  object-fit:cover;
  display:block;
  margin:0 auto 20px auto;
}

input, textarea{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--input);
  color:var(--text);
  margin-bottom:12px;
  font-size:15px;
}

button{
  padding:10px 16px;
  border:none;
  background:var(--accent);
  color:white;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
button:hover{ opacity:0.9; }

#msg{ margin-top:14px; font-weight:bold; opacity:0; transition:.3s; }
</style>
</head>

<body>

<nav>
  <a href="/">ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§</a>
  <a href="/friend.html">ãƒ•ãƒ¬ãƒ³ãƒ‰</a>
  <a href="/icon_upload.html">ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´</a>
  <button onclick="toggleTheme()" style="margin-left:auto;">ğŸŒ“</button>
</nav>

<div class="container">
  <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>

  <div class="card">

    <img id="icon" src="/icons/default.png">

    <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
    <input id="username" disabled style="opacity:0.7;">

    <label>è‡ªå·±ç´¹ä»‹</label>
    <textarea id="bio" rows="4" placeholder="è‡ªå·±ç´¹ä»‹ã‚’æ›¸ã„ã¦ãã ã•ã„"></textarea>

    <label>ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´</label>
    <input type="file" id="iconFile" accept="image/*">

    <button onclick="updateProfile()">ä¿å­˜</button>

    <div id="msg"></div>
  </div>
</div>


<script>
// ================================
// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
// ================================
async function loadProfile(){
  const user = localStorage.getItem("username");
  const msg = document.getElementById("msg");

  if(!user){
    msg.innerHTML = "<span style='color:red;'>â€» ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</span>";
    msg.style.opacity = 1;
    return;
  }

  document.getElementById("username").value = user;

  const res = await fetch(`/api/user/profile?user=${user}`);
  const data = await res.json();

  document.getElementById("bio").value  = data.bio  || "";
  document.getElementById("icon").src   = data.icon || "/icons/default.png";
}


// ================================
// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
// ================================
async function updateProfile(){
  const user = localStorage.getItem("username");
  const bio  = document.getElementById("bio").value;
  const file = document.getElementById("iconFile").files[0];
  const msg  = document.getElementById("msg");

  msg.style.opacity = 0;

  const fd = new FormData();
  fd.append("user", user);
  fd.append("bio", bio);
  if(file) fd.append("icon", file);

  const res = await fetch("/api/user/profile/update", {
    method: "POST",
    body: fd
  });

  const data = await res.json();

  if(data.ok){
    msg.innerHTML = "<span style='color:#2ecc71;'>âœ” ä¿å­˜ã—ã¾ã—ãŸï¼</span>";
  } else {
    msg.innerHTML = "<span style='color:red;'>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>";
  }

  msg.style.opacity = 1;
  loadProfile(); // æ›´æ–°å¾Œåæ˜ 
}


// ================================
loadProfile();
</script>

</body>
</html>
